{% extends "base.html" %}

{% block content %}
<div class="page-header">
  <div class="breadcrumb">
    <a href="/knowledge">知识库</a>
    <span class="text-muted">/</span>
    <span>运行记录</span>
  </div>
  <div class="row justify-between items-center">
    <h1 class="page-title">运行 #{{ run.run_id }}</h1>
    <div class="row gap-2">
      <span class="badge status-{{ run.status }}">{{ run.status|status_zh }}</span>
      <span class="text-sm text-muted font-mono">{{ run.started_at|tz8 }}</span>
    </div>
  </div>
</div>

<div class="grid grid-2 mb-4">
  <div class="panel h-full">
    <h2>运行统计</h2>
    <div class="grid grid-2">
      <div class="kpi">
        <div class="label">目标数</div>
        <div class="value">{{ run.target_count }}</div>
      </div>
      <div class="kpi success">
        <div class="label">建议数</div>
        <div class="value">{{ run.suggestion_count }}</div>
      </div>
      <div class="kpi warning">
        <div class="label">待复核</div>
        <div class="value">{{ run.needs_review_count }}</div>
      </div>
      <div class="kpi danger">
        <div class="label">失败数</div>
        <div class="value">{{ run.failure_count }}</div>
      </div>
    </div>
    <div class="mt-4 text-sm text-muted">
      结束时间: <strong>{{ run.finished_at|tz8 if run.finished_at else '运行中...' }}</strong>
    </div>
  </div>

  <div class="panel h-full">
    <h2>执行步骤 (Execution Steps)</h2>
    <div class="table-container" style="max-height: 240px; overflow-y: auto;">
      <table>
        <thead>
          <tr>
            <th>时间</th>
            <th>步骤</th>
            <th>状态</th>
            <th>消息</th>
          </tr>
        </thead>
        <tbody>
          {% for e in events %}
          <tr>
            <td class="code text-sm text-muted whitespace-nowrap">{{ e.created_at|tz8 }}</td>
            <td>{{ e.step|step_zh }}</td>
            <td><span class="badge status-{{ e.status }}">{{ e.status|status_zh }}</span></td>
            <td class="text-sm">{{ e.message }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="4" class="text-center text-muted">暂无步骤记录。</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="panel">
  <h2>生成的建议 (Generated Suggestions)</h2>
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>知识库</th>
          <th>页面标题</th>
          <th>状态</th>
          <th>置信度</th>
          <th>更新时间</th>
        </tr>
      </thead>
      <tbody>
        {% for s in suggestions %}
        <tr>
          <td><a href="/knowledge/suggestions/{{ s.suggestion_id }}"
              class="text-primary font-mono font-medium hover:underline">#{{ s.suggestion_id }}</a></td>
          <td><span class="badge">{{ s.logical_db|status_zh }}</span></td>
          <td class="text-main">{{ s.page_title }}</td>
          <td><span class="badge status-{{ s.status }}">{{ s.status|status_zh }}</span></td>
          <td>{{ '%.2f'|format(s.confidence or 0) }}</td>
          <td class="text-sm text-muted">{{ s.updated_at|tz8 }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6" class="text-center py-6 text-muted">本次运行未生成建议。</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}