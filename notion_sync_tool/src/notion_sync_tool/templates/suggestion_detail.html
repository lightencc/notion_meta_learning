{% extends "base.html" %}

{% block content %}
<div class="page-header">
  <div class="breadcrumb">
    <a href="/suggestions">复核队列</a>
    <span class="text-muted">/</span>
    <span>建议 #{{ row.suggestion_id }}</span>
  </div>
  <div class="row justify-between items-center">
    <h1 class="page-title">错题复核详情</h1>
    <div class="row gap-2">
      <span class="badge status-{{ row.status }}">{{ row.status|status_zh }}</span>
      <span class="text-muted text-sm">{{ row.updated_at|tz8 }}</span>
    </div>
  </div>
</div>

{% if action_notice %}<div class="badge status-completed mb-4 w-full">{{ action_notice }}</div>{% endif %}
{% if action_error %}<div class="badge status-failed mb-4 w-full">{{ action_error }}</div>{% endif %}

<div class="grid grid-2">
  <!-- Left Column: Context & Analysis -->
  <div class="flex flex-col gap-4">
    <!-- Step 1: Source Context -->
    <div class="panel">
      <h3>步骤 1: 原始上下文</h3>
      <div class="mb-4">
        <label class="text-muted text-xs uppercase tracking-wide">错题页面</label>
        <a href="{{ source.url }}" target="_blank"
          class="text-primary hover:underline font-medium flex items-center gap-1">
          {{ source.title }}
          <svg style="width:12px;height:12px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
            <polyline points="15 3 21 3 21 9"></polyline>
            <line x1="10" y1="14" x2="21" y2="3"></line>
          </svg>
        </a>
      </div>

      <div class="mb-4">
        <label class="text-muted text-xs uppercase tracking-wide">Property Text</label>
        <div class="code" style="max-height: 120px;">{{ source.property_text or '-' }}</div>
      </div>

      <div>
        <label class="text-muted text-xs uppercase tracking-wide">Page Content (Plain Text)</label>
        <div class="code" style="max-height: 200px;">{{ source.plain_text or '-' }}</div>
      </div>
    </div>

    <!-- Step 2: Candidates -->
    <div class="panel">
      <h3>Step 2: Retrieved Candidates</h3>

      <div class="mb-4">
        <label class="text-muted text-xs uppercase tracking-wide">Resources 资源 ({{ candidates.resources|length if
          candidates.resources else 0 }})</label>
        <div class="code" style="max-height: 100px;">{% for c in candidates.resources or [] %}{{ c.id }} | {{ c.title }}
          {% endfor %}</div>
      </div>

      <div class="mb-4">
        <label class="text-muted text-xs uppercase tracking-wide">Concepts 概念 ({{ candidates.concepts|length if
          candidates.concepts else 0 }})</label>
        <div class="code" style="max-height: 100px;">{% for c in candidates.concepts or [] %}{{ c.id }} | {{ c.title }}
          {% endfor %}</div>
      </div>

      <div class="mb-4">
        <label class="text-muted text-xs uppercase tracking-wide">Skills 技能 ({{ candidates.skills|length if
          candidates.skills else 0 }})</label>
        <div class="code" style="max-height: 100px;">{% for c in candidates.skills or [] %}{{ c.id }} | {{ c.title }}
          {% endfor %}</div>
      </div>

      <div class="mb-4">
        <label class="text-muted text-xs uppercase tracking-wide">Mindsets 心法 ({{ candidates.mindsets|length if
          candidates.mindsets else 0 }})</label>
        <div class="code" style="max-height: 100px;">{% for c in candidates.mindsets or [] %}{{ c.id }} | {{ c.title }}
          {% endfor %}</div>
      </div>

      <div>
        <label class="text-muted text-xs uppercase tracking-wide">Similar Errors 相似错题 ({{
          candidates.similar_errors|length if
          candidates.similar_errors else 0 }})</label>
        <div class="code" style="max-height: 100px;">{% for c in candidates.similar_errors or [] %}{{ c.id }} | {{
          c.title }}
          {% endfor %}</div>
      </div>
    </div>
  </div>

  <!-- Right Column: Proposal & Decision -->
  <div class="flex flex-col gap-4">
    <!-- Step 3: Proposal -->
    <div class="panel">
      <div class="row justify-between items-center mb-4">
        <h3>步骤 3: Agent 建议</h3>
        <div class="badge {{ 'status-completed' if (row.confidence or 0) > 0.8 else 'status-warning' }}">
          置信度: {{ '%.2f'|format(row.confidence or 0) }}
        </div>
      </div>

      <form method="post" action="/suggestions/{{ row.suggestion_id }}/save">
        <fieldset>
          <legend>复核与编辑</legend>
          <div class="grid gap-4">
            <div>
              <label>建议标题</label>
              <input type="text" name="proposed_title" value="{{ row.proposed_title or '' }}" class="w-full" />
            </div>

            <div class="grid grid-2">
              <div>
                <label>Resource (资源)</label>
                <select name="proposed_resource_id">
                  <option value="">-- 请选择 --</option>
                  {% for c in candidates.resources or [] %}
                  <option value="{{ c.id }}" {% if row.proposed_resource_id==c.id %}selected{% endif %}>{{ c.title }}
                    ({{ c.id[:8] }})</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label>Concept (概念)</label>
                <select name="proposed_concept_id">
                  <option value="">-- 请选择 --</option>
                  {% for c in candidates.concepts or [] %}
                  <option value="{{ c.id }}" {% if row.proposed_concept_id==c.id %}selected{% endif %}>{{ c.title }} ({{
                    c.id[:8] }})</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label>Skill (技能)</label>
                <select name="proposed_skill_id">
                  <option value="">-- 请选择 --</option>
                  {% for c in candidates.skills or [] %}
                  <option value="{{ c.id }}" {% if row.proposed_skill_id==c.id %}selected{% endif %}>{{ c.title }} ({{
                    c.id[:8] }})</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label>Mindset (心法)</label>
                <select name="proposed_mindset_id">
                  <option value="">-- 请选择 --</option>
                  {% for c in candidates.mindsets or [] %}
                  <option value="{{ c.id }}" {% if row.proposed_mindset_id==c.id %}selected{% endif %}>{{ c.title }} ({{
                    c.id[:8] }})</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div>
              <label>相似错题 ID (逗号分隔)</label>
              <input type="text" name="proposed_similar_ids" value="{{ selected_similar|join(',') }}" />
            </div>

            <div>
              <label>复核备注</label>
              <textarea name="reviewer_note" rows="3" placeholder="在此添加您的备注...">{{ row.reviewer_note or '' }}</textarea>
            </div>
          </div>

          <div class="mt-4 flex justify-end">
            <button type="submit" class="btn secondary text-sm">保存草稿</button>
          </div>
        </fieldset>
      </form>
    </div>

    <!-- Step 4: Decision -->
    <div class="panel">
      <h3>步骤 4: 决策</h3>

      <div class="grid gap-3">
        <form method="post" action="/suggestions/{{ row.suggestion_id }}/regenerate-apply">
          <input type="hidden" name="reviewer_note" value="{{ row.reviewer_note or '' }}" />
          <button class="btn warning w-full js-long-task" data-loading-text="重新生成中..." type="submit">
            重新生成 并 应用到 Notion
          </button>
        </form>

        <div class="grid grid-2 gap-3">
          <form method="post" action="/suggestions/{{ row.suggestion_id }}/approve">
            <input type="hidden" name="reviewer_note" value="{{ row.reviewer_note or '' }}" />
            <button class="btn success w-full js-long-task" data-loading-text="批准中..." type="submit">
              批准 (Approve)
            </button>
          </form>

          <form method="post" action="/suggestions/{{ row.suggestion_id }}/reject">
            <input type="hidden" name="reviewer_note" value="{{ row.reviewer_note or '' }}" />
            <button class="btn danger w-full" type="submit">
              拒绝 (Reject)
            </button>
          </form>
        </div>
      </div>

      {% if row.validation_notes %}
      <div class="mt-4 p-3 bg-body rounded border border-color">
        <div class="text-xs uppercase text-muted font-bold mb-1">Validation Notes</div>
        <div class="text-sm">{{ row.validation_notes }}</div>
      </div>
      {% endif %}

      {% if row.failure_reason %}
      <div class="mt-4 p-3 bg-danger rounded border border-danger text-danger">
        <div class="text-xs uppercase font-bold mb-1">Failure Reason</div>
        <div class="text-sm">{{ row.failure_reason }}</div>
      </div>
      {% endif %}
    </div>

    <div class="panel collapsed">
      <details>
        <summary class="cursor-pointer font-medium text-primary">查看原始 Agent JSON</summary>
        <div class="code mt-4 text-xs">{{ model_response_pretty }}</div>
      </details>
    </div>
  </div>
</div>
{% endblock %}