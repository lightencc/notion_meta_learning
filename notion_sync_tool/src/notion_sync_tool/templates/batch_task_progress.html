{% extends "base.html" %}

{% block content %}
<div class="page-header">
  <div class="breadcrumb">
    <span>首页</span>
    <span class="text-muted">/</span>
    <span>批处理任务</span>
  </div>
  <h1 class="page-title">{{ task_title }}</h1>
  <div class="text-sm text-muted font-mono mt-2">
    任务 ID: {{ task_id }}
  </div>
</div>

<div class="panel">
  <div class="grid grid-4 mb-6">
    <div class="kpi">
      <div class="label">状态</div>
      <div class="value" id="task-status" style="font-size: 20px;">初始化中...</div>
    </div>
    <div class="kpi">
      <div class="label">已处理</div>
      <div class="value">
        <span id="processed-count">0</span><span class="text-muted text-lg font-normal"> / <span
            id="total-count">0</span></span>
      </div>
    </div>
    <div class="kpi success">
      <div class="label">成功</div>
      <div class="value" id="success-count">0</div>
    </div>
    <div class="kpi danger">
      <div class="label">失败</div>
      <div class="value" id="failed-count">0</div>
    </div>
  </div>

  <div class="w-full bg-body rounded-full h-4 mb-4 overflow-hidden border border-color">
    <div id="progress-bar" class="bg-primary h-full transition-all duration-300" style="width: 0%"></div>
  </div>

  <div class="text-center mb-6">
    <div id="task-message" class="text-lg font-medium text-main mb-2">任务启动中...</div>
    <div id="current-item" class="text-sm text-muted">当前项目: -</div>
    <div id="last-error" class="text-sm text-danger mt-2 font-medium"></div>
  </div>

  <div class="flex justify-center">
    <a class="btn secondary" href="{{ back_url }}">
      <svg style="width:14px;height:14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="19" y1="12" x2="5" y2="12"></line>
        <polyline points="12 19 5 12 12 5"></polyline>
      </svg>
      返回队列
    </a>
  </div>
</div>

<script>
  const statusUrl = {{ status_url| tojson }};
  const doneRedirectUrl = {{ done_redirect_url| tojson }};
  let redirected = false;

  function toPercent(processed, total) {
    if (!total || total <= 0) return 0;
    return Math.max(0, Math.min(100, Math.round((processed / total) * 100)));
  }

  function statusToText(status) {
    if (status === "completed") return "已完成";
    if (status === "failed") return "失败";
    if (status === "running") return "运行中";
    return status || "-";
  }

  async function refreshStatus() {
    try {
      const resp = await fetch(statusUrl, { cache: "no-store" });
      if (!resp.ok) return;
      const data = await resp.json();
      const processed = Number(data.processed || 0);
      const total = Number(data.total || 0);
      const success = Number(data.success || 0);
      const failed = Number(data.failed || 0);
      const pct = toPercent(processed, total);

      document.getElementById("task-status").textContent = statusToText(data.status);
      document.getElementById("processed-count").textContent = String(processed);
      document.getElementById("total-count").textContent = String(total);
      document.getElementById("success-count").textContent = String(success);
      document.getElementById("failed-count").textContent = String(failed);
      document.getElementById("progress-bar").style.width = pct + "%";

      const messageEl = document.getElementById("task-message");
      messageEl.textContent = data.message || (data.status === "running" ? "处理中..." : "完成");

      const title = (data.current_item_title || "").trim();
      const currentId = data.current_item_id ? ("#" + data.current_item_id) : "";
      document.getElementById("current-item").textContent = "正在处理: " + (currentId || title ? (currentId + (title ? (" " + title) : "")) : "-");

      const errorEl = document.getElementById("last-error");
      if (data.last_error) {
        errorEl.textContent = "最新错误: " + data.last_error;
        errorEl.style.display = 'block';
      } else {
        errorEl.style.display = 'none';
      }

      if (!redirected && (data.status === "completed" || data.status === "failed")) {
        redirected = true;
        setTimeout(() => { window.location.href = doneRedirectUrl; }, 1500);
      }
    } catch (error) {
      document.getElementById("task-message").textContent = "连接中断，正在重试...";
    }
  }

  refreshStatus();
  setInterval(refreshStatus, 1000);
</script>
{% endblock %}