{% extends "base.html" %}
{% block content %}
<div class="panel">
  <h2>错题复核队列</h2>
  {% if batch_notice %}
  <div class="muted" style="margin-bottom: 8px;color:#1a9a55;">
    {{ batch_notice }}
  </div>
  {% endif %}
  {% if batch_error %}
  <div class="muted" style="margin-bottom: 8px;color:#b32522;">
    {{ batch_error }}
  </div>
  {% endif %}
  <form method="get" action="/suggestions" class="row" style="max-width: 340px;">
    <div>
      <label>状态筛选</label>
      <select name="status" onchange="this.form.submit()">
        {% for value in ['all', 'pending_review', 'needs_review', 'applied', 'rejected', 'failed'] %}
        <option value="{{ value }}" {% if status == value %}selected{% endif %}>{{ value|status_zh }}</option>
        {% endfor %}
      </select>
    </div>
  </form>
</div>

<div class="panel">
  <form method="post" action="/suggestions/batch">
    <input type="hidden" name="status" value="{{ status }}" />
    <div class="row" style="margin-bottom: 10px;">
      <div style="min-width: 220px;">
        <label>复核备注（批量）</label>
        <input type="text" name="reviewer_note" placeholder="例如：批量通过，已抽查" />
      </div>
      <button class="btn warn js-long-task" data-loading-text="重生成并回写中..." type="submit" name="action" value="regenerate_apply">批量重新生成并回写 Notion</button>
      <button class="btn success js-long-task" data-loading-text="批量回写中..." type="submit" name="action" value="approve">批量确认并回写 Notion</button>
      <button class="btn danger" type="submit" name="action" value="reject">批量驳回</button>
      <button class="btn secondary" type="submit" name="action" value="pending">批量改为待复核</button>
    </div>
    <table>
      <thead>
        <tr>
          <th><input style="width:auto;" type="checkbox" id="select-all" onclick="toggleAll(this)" /></th>
          <th>ID</th>
          <th>错题标题</th>
          <th>状态</th>
          <th>置信度</th>
          <th>建议标题</th>
          <th>更新时间</th>
        </tr>
      </thead>
      <tbody>
        {% for row in suggestions %}
        <tr>
          <td><input style="width:auto;" type="checkbox" name="suggestion_ids" value="{{ row.suggestion_id }}" class="row-check" /></td>
          <td><a href="/suggestions/{{ row.suggestion_id }}">#{{ row.suggestion_id }}</a></td>
          <td>{{ row.error_title }}</td>
          <td><span class="badge status-{{ row.status }}">{{ row.status|status_zh }}</span></td>
          <td>{{ '%.2f'|format(row.confidence or 0) }}</td>
          <td>{{ row.proposed_title or '-' }}</td>
          <td>{{ row.updated_at|tz8 }}</td>
        </tr>
        {% else %}
        <tr><td colspan="7" class="muted">暂无建议。</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </form>
</div>
<script>
  function toggleAll(source) {
    const checked = source.checked;
    document.querySelectorAll('.row-check').forEach((el) => { el.checked = checked; });
  }
</script>
{% endblock %}
