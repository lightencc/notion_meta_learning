{% extends "base.html" %}

{% block content %}
<div class="page-header">
  <div class="breadcrumb">
    <span>首页</span>
    <span class="text-muted">/</span>
    <a href="/knowledge">知识库</a>
    <span class="text-muted">/</span>
    <span>复核队列</span>
  </div>
  <h1 class="page-title">知识库复核队列</h1>
</div>

<div class="panel">
  <div class="text-sm text-muted mb-4 bg-body p-3 rounded border border-color">
    ℹ️ Notion 页面内容仅在您 "批准并写入" 后才会从 "Empty" 更新为生成的内容。
  </div>

  <div class="row justify-between items-center mb-4">
    <div class="row items-center gap-4">
      <form method="get" action="/knowledge/suggestions" class="flex items-center gap-4">
        <div class="flex items-center gap-2">
          <label class="text-sm font-medium whitespace-nowrap">状态:</label>
          <select name="status" onchange="this.form.submit()" style="width: 160px;">
            {% for value in ['all', 'pending_review', 'needs_review', 'applied', 'rejected', 'failed'] %}
            <option value="{{ value }}" {% if status==value %}selected{% endif %}>{{ value|status_zh }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="flex items-center gap-2">
          <label class="text-sm font-medium whitespace-nowrap">Library:</label>
          <select name="logical_db" onchange="this.form.submit()" style="width: 160px;">
            {% for value in ['all', 'resources', 'concepts', 'skills', 'mindsets'] %}
            <option value="{{ value }}" {% if logical_db==value %}selected{% endif %}>{{ value|status_zh }}</option>
            {% endfor %}
          </select>
        </div>
      </form>
    </div>

    {% if batch_notice %}<div class="badge status-completed">{{ batch_notice }}</div>{% endif %}
    {% if batch_error %}<div class="badge status-failed">{{ batch_error }}</div>{% endif %}
  </div>

  <form method="post" action="/knowledge/suggestions/batch">
    <input type="hidden" name="status" value="{{ status }}" />
    <input type="hidden" name="logical_db" value="{{ logical_db }}" />

    <div class="bg-body p-4 rounded border border-color mb-4">
      <div class="row items-center gap-4">
        <div class="flex-1">
          <input type="text" name="reviewer_note" placeholder="Batch action note (e.g., Sampling check passed)" />
        </div>
        <div class="row gap-2">
          <button class="btn success js-long-task" data-loading-text="Writing..." type="submit" name="action"
            value="approve">
            <svg style="width:14px;height:14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            Approve & Write
          </button>
          <button class="btn danger" type="submit" name="action" value="reject">
            <svg style="width:14px;height:14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
            Reject
          </button>
          <button class="btn secondary" type="submit" name="action" value="pending">
            Reset to Pending
          </button>
        </div>
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th style="width: 40px;"><input type="checkbox" id="select-all" onclick="toggleAll(this)"
                style="width:auto;margin:0;" /></th>
            <th style="width: 80px;">ID</th>
            <th>知识库</th>
            <th>页面标题</th>
            <th>状态</th>
            <th>置信度</th>
            <th style="width: 160px;">更新时间</th>
          </tr>
        </thead>
        <tbody>
          {% for row in suggestions %}
          <tr>
            <td><input type="checkbox" name="suggestion_ids" value="{{ row.suggestion_id }}" class="row-check"
                style="width:auto;margin:0;" /></td>
            <td><a href="/knowledge/suggestions/{{ row.suggestion_id }}"
                class="text-primary font-mono font-medium hover:underline">#{{ row.suggestion_id }}</a></td>
            <td><span class="badge">{{ row.logical_db|status_zh }}</span></td>
            <td class="font-medium text-main">{{ row.page_title }}</td>
            <td><span class="badge status-{{ row.status }}">{{ row.status|status_zh }}</span></td>
            <td>
              <div class="flex items-center gap-2">
                <div
                  style="width: 60px; height: 4px; background: var(--border-color); border-radius: 99px; overflow: hidden;">
                  <div
                    style="width: {{ (row.confidence or 0) * 100 }}%; height: 100%; background: var(--{{ 'success-text' if (row.confidence or 0) > 0.8 else ('warning-text' if (row.confidence or 0) > 0.5 else 'danger-text') }});">
                  </div>
                </div>
                <span class="text-sm text-muted">{{ '%.2f'|format(row.confidence or 0) }}</span>
              </div>
            </td>
            <td class="text-sm text-muted">{{ row.updated_at|tz8 }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="7" class="text-center py-8 text-muted">No suggestions found in this queue.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </form>
</div>

<script>
  function toggleAll(source) {
    const checked = source.checked;
    document.querySelectorAll('.row-check').forEach((el) => { el.checked = checked; });
  }
</script>
{% endblock %}